#!/bin/bash

# Docker Development Commands
# Admin Management System

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
print_help() {
    echo "Admin Management System - Docker Development Scripts"
    echo ""
    echo "Available commands:"
    echo "  up           Start all containers"
    echo "  down         Stop all containers"
    echo "  build        Build and start containers"
    echo "  rebuild      Force rebuild all containers"
    echo "  bash         Open bash in app container"
    echo "  artisan      Run Laravel artisan command"
    echo "  composer     Run composer command"
    echo "  npm          Run npm command"
    echo "  test         Run PHPUnit tests"
    echo "  migrate      Run database migrations"
    echo "  seed         Run database seeders"
    echo "  fresh        Fresh migrate and seed database"
    echo "  logs         Show container logs"
    echo "  status       Show container status"
    echo "  clean        Remove all containers and volumes"
    echo "  help         Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 up                    # Start all services"
    echo "  $0 bash                  # Enter app container"
    echo "  $0 artisan migrate       # Run migrations"
    echo "  $0 npm install           # Install npm dependencies"
    echo "  $0 test                  # Run tests"
}

# Check if docker-compose files exist
check_docker_files() {
    if [[ ! -f "docker-compose.yml" ]]; then
        echo -e "${RED}Error: docker-compose.yml not found${NC}"
        exit 1
    fi
}

# Main script logic
case "${1:-help}" in
    up)
        echo -e "${GREEN}Starting containers...${NC}"
        docker compose up -d
        echo -e "${GREEN}Containers started successfully!${NC}"
        echo -e "${YELLOW}App: http://localhost:${APP_PORT:-8080}${NC}"
        echo -e "${YELLOW}Mailpit: http://localhost:${FORWARD_MAILPIT_DASHBOARD_PORT:-8025}${NC}"
        ;;
    down)
        echo -e "${YELLOW}Stopping containers...${NC}"
        docker compose down
        echo -e "${GREEN}Containers stopped.${NC}"
        ;;
    build)
        echo -e "${GREEN}Building and starting containers...${NC}"
        docker compose up --build -d
        echo -e "${GREEN}Containers built and started!${NC}"
        ;;
    rebuild)
        echo -e "${GREEN}Force rebuilding containers...${NC}"
        docker compose build --no-cache
        docker compose up -d
        echo -e "${GREEN}Containers rebuilt and started!${NC}"
        ;;
    bash)
        echo -e "${GREEN}Opening bash in app container...${NC}"
        docker compose exec app bash
        ;;
    artisan)
        shift
        echo -e "${GREEN}Running artisan: $@${NC}"
        docker compose exec app php artisan "$@"
        ;;
    composer)
        shift
        echo -e "${GREEN}Running composer: $@${NC}"
        docker compose exec app composer "$@"
        ;;
    npm)
        shift
        echo -e "${GREEN}Running npm: $@${NC}"
        docker compose exec vite npm "$@"
        ;;
    test)
        echo -e "${GREEN}Running PHPUnit tests...${NC}"
        docker compose exec app php artisan test
        ;;
    migrate)
        echo -e "${GREEN}Running database migrations...${NC}"
        docker compose exec app php artisan migrate
        ;;
    seed)
        echo -e "${GREEN}Running database seeders...${NC}"
        docker compose exec app php artisan db:seed
        ;;
    fresh)
        echo -e "${GREEN}Fresh migrate and seed database...${NC}"
        docker compose exec app php artisan migrate:fresh --seed
        ;;
    logs)
        if [[ -n "$2" ]]; then
            docker compose logs -f "$2"
        else
            docker compose logs -f
        fi
        ;;
    status)
        docker compose ps
        ;;
    clean)
        echo -e "${RED}WARNING: This will remove all containers and volumes!${NC}"
        read -p "Are you sure? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose down -v --remove-orphans
            docker system prune -f
            echo -e "${GREEN}All containers and volumes removed.${NC}"
        else
            echo -e "${YELLOW}Operation cancelled.${NC}"
        fi
        ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        print_help
        exit 1
        ;;
esac
